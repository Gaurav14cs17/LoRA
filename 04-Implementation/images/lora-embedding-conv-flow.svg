<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 440" font-family="Segoe UI,system-ui,sans-serif">
  <defs>
    <filter id="sh5" x="-3%" y="-3%" width="108%" height="108%"><feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.1"/></filter>
    <marker id="arr5" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#64748b"/></marker>
  </defs>
  <rect width="850" height="440" rx="16" fill="#fafbff" stroke="#e2e8f0" stroke-width="1.5"/>
  <text x="425" y="32" text-anchor="middle" font-size="18" font-weight="700" fill="#1e293b">LoRAEmbedding and LoRAConv2d Data Flow</text>

  <rect x="30" y="55" width="390" height="155" rx="10" fill="#f0fdf4" stroke="#16a34a" stroke-width="1.5"/>
  <text x="225" y="80" text-anchor="middle" font-size="13" font-weight="700" fill="#15803d">LoRAEmbedding</text>

  <rect x="55" y="95" width="85" height="45" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="97" y="120" text-anchor="middle" font-size="10" font-weight="700" fill="#1d4ed8">tokens</text>

  <line x1="140" y1="117" x2="170" y2="117" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr5)"/>

  <rect x="175" y="92" width="95" height="50" rx="8" fill="#bfdbfe" stroke="#60a5fa" stroke-width="1"/>
  <text x="222" y="112" text-anchor="middle" font-size="9" font-weight="700" fill="#1d4ed8">W_emb</text>
  <text x="222" y="127" text-anchor="middle" font-size="8" fill="#3b82f6">frozen lookup</text>

  <rect x="175" y="152" width="95" height="50" rx="8" fill="#fed7aa" stroke="#f97316" stroke-width="1"/>
  <text x="222" y="172" text-anchor="middle" font-size="9" font-weight="700" fill="#c2410c">A_emb</text>
  <text x="222" y="187" text-anchor="middle" font-size="8" fill="#ea580c">lookup</text>

  <line x1="270" y1="117" x2="295" y2="117" stroke="#3b82f6" stroke-width="1.5"/>
  <line x1="270" y1="177" x2="295" y2="177" stroke="#ea580c" stroke-width="1.5"/>
  <rect x="300" y="135" width="75" height="50" rx="6" fill="#fff7ed" stroke="#ea580c" stroke-width="1.5"/>
  <text x="337" y="158" text-anchor="middle" font-size="10" font-weight="700" fill="#c2410c">B matmul</text>
  <line x1="375" y1="160" x2="400" y2="160" stroke="#ea580c" stroke-width="1.5"/>
  <rect x="405" y="140" width="85" height="45" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
  <text x="447" y="163" text-anchor="middle" font-size="9" font-weight="700" fill="#b45309">scale, sum</text>
  <line x1="490" y1="162" x2="510" y2="162" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arr5)"/>
  <rect x="515" y="137" width="55" height="50" rx="8" fill="#dcfce7" stroke="#16a34a" stroke-width="1.5"/>
  <text x="542" y="167" text-anchor="middle" font-size="10" font-weight="700" fill="#15803d">h</text>

  <rect x="55" y="225" width="150" height="55" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="1"/>
  <text x="130" y="248" text-anchor="middle" font-size="9" font-weight="700" fill="#991b1b">Key: embedding dim</text>
  <text x="130" y="263" text-anchor="middle" font-size="8" fill="#dc2626">A_emb per token, B shared</text>

  <rect x="30" y="265" width="390" height="155" rx="10" fill="#fff7ed" stroke="#ea580c" stroke-width="1.5"/>
  <text x="225" y="290" text-anchor="middle" font-size="13" font-weight="700" fill="#c2410c">LoRAConv2d</text>

  <rect x="55" y="305" width="85" height="45" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
  <text x="97" y="330" text-anchor="middle" font-size="9" font-weight="700" fill="#1d4ed8">feature map</text>

  <line x1="140" y1="327" x2="170" y2="327" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arr5)"/>

  <rect x="175" y="298" width="95" height="58" rx="8" fill="#bfdbfe" stroke="#60a5fa" stroke-width="1"/>
  <text x="222" y="320" text-anchor="middle" font-size="9" font-weight="700" fill="#1d4ed8">Conv2d</text>
  <text x="222" y="335" text-anchor="middle" font-size="8" fill="#3b82f6">frozen</text>

  <rect x="175" y="366" width="95" height="35" rx="8" fill="#fed7aa" stroke="#f97316" stroke-width="1"/>
  <text x="222" y="388" text-anchor="middle" font-size="9" font-weight="700" fill="#c2410c">Conv_A</text>
  <text x="222" y="398" text-anchor="middle" font-size="7" fill="#ea580c">rank channels</text>

  <line x1="270" y1="327" x2="295" y2="327" stroke="#3b82f6" stroke-width="1.5"/>
  <line x1="270" y1="387" x2="295" y2="387" stroke="#ea580c" stroke-width="1.5"/>
  <rect x="300" y="350" width="85" height="45" rx="6" fill="#fff7ed" stroke="#ea580c" stroke-width="1.5"/>
  <text x="342" y="368" text-anchor="middle" font-size="9" font-weight="700" fill="#c2410c">B matmul</text>
  <text x="342" y="382" text-anchor="middle" font-size="7" fill="#ea580c">(permute)</text>
  <line x1="385" y1="372" x2="405" y2="372" stroke="#ea580c" stroke-width="1.5"/>
  <rect x="410" y="355" width="75" height="40" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
  <text x="447" y="378" text-anchor="middle" font-size="9" font-weight="700" fill="#b45309">scale, sum</text>
  <line x1="485" y1="375" x2="505" y2="375" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arr5)"/>
  <rect x="510" y="358" width="55" height="45" rx="8" fill="#dcfce7" stroke="#16a34a" stroke-width="1.5"/>
  <text x="537" y="385" text-anchor="middle" font-size="10" font-weight="700" fill="#15803d">h</text>

  <rect x="55" y="385" width="160" height="28" rx="6" fill="#fef2f2" stroke="#dc2626" stroke-width="1"/>
  <text x="135" y="404" text-anchor="middle" font-size="8" font-weight="700" fill="#991b1b">Key: spatial, Conv_A/B shapes</text>

  <rect x="450" y="55" width="380" height="365" rx="10" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5"/>
  <text x="640" y="85" text-anchor="middle" font-size="12" font-weight="700" fill="#475569">Key Differences</text>

  <rect x="475" y="105" width="330" height="75" rx="8" fill="#f0fdf4" stroke="#16a34a" stroke-width="1"/>
  <text x="640" y="128" text-anchor="middle" font-size="10" font-weight="700" fill="#15803d">LoRAEmbedding</text>
  <text x="640" y="145" text-anchor="middle" font-size="9" fill="#475569">Per-token lookup in A_emb, B projects to hidden</text>
  <text x="640" y="162" text-anchor="middle" font-size="9" fill="#475569">Token indices, not full matrix multiply</text>

  <rect x="475" y="195" width="330" height="95" rx="8" fill="#fff7ed" stroke="#ea580c" stroke-width="1"/>
  <text x="640" y="218" text-anchor="middle" font-size="10" font-weight="700" fill="#c2410c">LoRAConv2d</text>
  <text x="640" y="235" text-anchor="middle" font-size="9" fill="#475569">Conv_A reduces input channels, Conv_B expands</text>
  <text x="640" y="252" text-anchor="middle" font-size="9" fill="#475569">Spatial structure preserved, permute for matmul</text>
  <text x="640" y="278" text-anchor="middle" font-size="9" fill="#64748b">Use in diffusion Down/Up blocks</text>

  <rect x="475" y="305" width="330" height="95" rx="8" fill="#eff6ff" stroke="#3b82f6" stroke-width="1"/>
  <text x="640" y="328" text-anchor="middle" font-size="10" font-weight="700" fill="#1d4ed8">Both: frozen base + LoRA delta, scale &#945;/r</text>
  <text x="640" y="348" text-anchor="middle" font-size="9" fill="#475569">Shared pattern: h = h_base + (&#945;/r) &#215; LoRA_part</text>
  <text x="640" y="368" text-anchor="middle" font-size="9" fill="#475569">Different layer types need different injection</text>
  <text x="640" y="388" text-anchor="middle" font-size="9" fill="#64748b">PEFT supports Embedding, Linear, Conv2d</text>
</svg>