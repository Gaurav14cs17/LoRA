<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 330">
  <defs>
    <marker id="aq" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0,0 8,3 0,6" fill="#475569"/>
    </marker>
  </defs>
  <rect width="800" height="330" rx="12" fill="#0f172a"/>
  <text x="400" y="35" text-anchor="middle" fill="#e2e8f0" font-family="Arial,sans-serif" font-size="18" font-weight="bold">QLoRA Implementation: 4-bit Base + LoRA Adapters</text>

  <!-- Step 1: Load in 4-bit -->
  <rect x="25" y="60" width="230" height="115" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="2"/>
  <text x="140" y="85" text-anchor="middle" fill="#ef4444" font-family="Arial,sans-serif" font-size="13" font-weight="bold">Step 1: Load in 4-bit</text>
  <line x1="45" y1="95" x2="235" y2="95" stroke="#334155" stroke-width="1"/>
  <text x="45" y="115" fill="#94a3b8" font-family="Arial,sans-serif" font-size="10">BitsAndBytesConfig(</text>
  <text x="55" y="130" fill="#e2e8f0" font-family="Arial,sans-serif" font-size="10">load_in_4bit=True</text>
  <text x="55" y="145" fill="#e2e8f0" font-family="Arial,sans-serif" font-size="10">bnb_4bit_quant_type="nf4"</text>
  <text x="55" y="160" fill="#e2e8f0" font-family="Arial,sans-serif" font-size="10">bnb_4bit_compute_dtype=bf16</text>

  <line x1="255" y1="117" x2="285" y2="117" stroke="#475569" stroke-width="2" marker-end="url(#aq)"/>

  <!-- Step 2: Apply LoRA -->
  <rect x="290" y="60" width="230" height="115" rx="8" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
  <text x="405" y="85" text-anchor="middle" fill="#10b981" font-family="Arial,sans-serif" font-size="13" font-weight="bold">Step 2: Apply LoRA</text>
  <line x1="310" y1="95" x2="500" y2="95" stroke="#334155" stroke-width="1"/>
  <text x="310" y="115" fill="#94a3b8" font-family="Arial,sans-serif" font-size="10">LoraConfig(r=16, ...)</text>
  <text x="310" y="135" fill="#94a3b8" font-family="Arial,sans-serif" font-size="10">get_peft_model(model, cfg)</text>
  <text x="310" y="160" fill="#10b981" font-family="Arial,sans-serif" font-size="10" font-weight="bold">LoRA adapters in fp16/bf16</text>
  <text x="310" y="172" fill="#64748b" font-family="Arial,sans-serif" font-size="9">on top of frozen 4-bit base</text>

  <line x1="520" y1="117" x2="550" y2="117" stroke="#475569" stroke-width="2" marker-end="url(#aq)"/>

  <!-- Step 3: Train -->
  <rect x="555" y="60" width="220" height="115" rx="8" fill="#1e293b" stroke="#8b5cf6" stroke-width="2"/>
  <text x="665" y="85" text-anchor="middle" fill="#8b5cf6" font-family="Arial,sans-serif" font-size="13" font-weight="bold">Step 3: Train</text>
  <line x1="575" y1="95" x2="755" y2="95" stroke="#334155" stroke-width="1"/>
  <text x="575" y="115" fill="#94a3b8" font-family="Arial,sans-serif" font-size="10">paged_adamw_8bit</text>
  <text x="575" y="135" fill="#94a3b8" font-family="Arial,sans-serif" font-size="10">gradient_checkpointing</text>
  <text x="575" y="155" fill="#8b5cf6" font-family="Arial,sans-serif" font-size="10" font-weight="bold">Only LoRA params update</text>
  <text x="575" y="172" fill="#64748b" font-family="Arial,sans-serif" font-size="9">4-bit W dequantized on-the-fly</text>

  <!-- Memory comparison -->
  <rect x="40" y="200" width="720" height="90" rx="8" fill="#1e293b" stroke="#475569" stroke-width="1"/>
  <text x="400" y="225" text-anchor="middle" fill="#e2e8f0" font-family="Arial,sans-serif" font-size="13" font-weight="bold">Memory Comparison (LLaMA-7B)</text>

  <rect x="60" y="240" width="500" height="20" rx="4" fill="#ef4444" opacity="0.3"/>
  <text x="310" y="255" text-anchor="middle" fill="#ef4444" font-family="Arial,sans-serif" font-size="10">Full FT: ~120 GB (4x A100)</text>

  <rect x="60" y="265" width="133" height="20" rx="4" fill="#f59e0b" opacity="0.3"/>
  <text x="310" y="280" text-anchor="middle" fill="#f59e0b" font-family="Arial,sans-serif" font-size="10">LoRA fp16: ~32 GB (1x A100)</text>

  <rect x="60" y="265" width="133" height="20" rx="4" fill="#10b981" opacity="0.5"/>
  <text x="650" y="255" text-anchor="middle" fill="#10b981" font-family="Arial,sans-serif" font-size="12" font-weight="bold">QLoRA: ~6 GB</text>
  <text x="650" y="275" text-anchor="middle" fill="#10b981" font-family="Arial,sans-serif" font-size="10">Single RTX 3090!</text>

  <!-- Bottom -->
  <text x="400" y="318" text-anchor="middle" fill="#94a3b8" font-family="Arial,sans-serif" font-size="11">QLoRA = BitsAndBytes 4-bit quantization + LoRA &#8594; same code, just add load_in_4bit=True</text>
</svg>
