<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 920 540" font-family="'Segoe UI', system-ui, -apple-system, sans-serif">
  <defs>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="112%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
    </filter>
    <marker id="arr" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#64748B"/>
    </marker>
    <marker id="arrPink" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#EC4899"/>
    </marker>
    <marker id="arrAmber" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#F59E0B"/>
    </marker>
    <marker id="arrBlue" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#3B82F6"/>
    </marker>
  </defs>

  <rect width="920" height="540" rx="12" fill="#FAFBFC"/>

  <!-- Title -->
  <text x="460" y="36" text-anchor="middle" font-size="18" font-weight="700" fill="#1E293B">DoRA — Weight-Decomposed Low-Rank Adaptation</text>
  <text x="460" y="56" text-anchor="middle" font-size="12" fill="#64748B">Decomposes weight into magnitude and direction, applies LoRA to direction only</text>
  <line x1="160" y1="68" x2="760" y2="68" stroke="#E2E8F0" stroke-width="1"/>

  <!-- Formula box -->
  <rect x="200" y="78" width="520" height="38" rx="8" fill="#F5F3FF" stroke="#DDD6FE" stroke-width="1"/>
  <text x="460" y="102" text-anchor="middle" font-size="14" font-weight="600" fill="#4C1D95">h = m · (W₀ + (α/r)·BA) / ‖W₀ + (α/r)·BA‖_col · x</text>

  <!-- Input -->
  <rect x="30" y="190" width="100" height="55" rx="8" fill="#F1F5F9" stroke="#94A3B8" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="80" y="213" text-anchor="middle" font-size="14" font-weight="700" fill="#1E293B">x</text>
  <text x="80" y="232" text-anchor="middle" font-size="10" fill="#64748B">(B, S, d_in)</text>

  <!-- Fork -->
  <circle cx="170" cy="217" r="4" fill="#64748B"/>
  <line x1="130" y1="217" x2="170" y2="217" stroke="#64748B" stroke-width="2"/>

  <!-- === Direction Path (LoRA) === -->
  <line x1="170" y1="217" x2="170" y2="280" stroke="#F59E0B" stroke-width="2"/>
  <line x1="170" y1="280" x2="220" y2="280" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrAmber)"/>

  <text x="205" y="320" font-size="11" font-weight="600" fill="#F59E0B">DIRECTION PATH</text>

  <!-- Frozen W0 -->
  <rect x="225" y="258" width="110" height="46" rx="8" fill="#EFF6FF" stroke="#3B82F6" stroke-width="1.5"/>
  <text x="280" y="278" text-anchor="middle" font-size="12" font-weight="600" fill="#1E40AF">W₀</text>
  <text x="280" y="296" text-anchor="middle" font-size="9" fill="#3B82F6">frozen ❄️</text>

  <text x="348" y="284" text-anchor="middle" font-size="16" font-weight="700" fill="#64748B">+</text>

  <!-- LoRA A -->
  <rect x="370" y="250" width="70" height="40" rx="6" fill="#FEF3C7" stroke="#F59E0B" stroke-width="1.5"/>
  <text x="405" y="268" text-anchor="middle" font-size="12" font-weight="700" fill="#92400E">A</text>
  <text x="405" y="283" text-anchor="middle" font-size="9" fill="#B45309">(d_in, r)</text>

  <line x1="440" y1="270" x2="455" y2="270" stroke="#F59E0B" stroke-width="1.5"/>
  <text x="460" y="268" font-size="10" fill="#64748B">@</text>

  <!-- LoRA B -->
  <rect x="475" y="250" width="70" height="40" rx="6" fill="#FEF3C7" stroke="#F59E0B" stroke-width="1.5"/>
  <text x="510" y="268" text-anchor="middle" font-size="12" font-weight="700" fill="#92400E">B</text>
  <text x="510" y="283" text-anchor="middle" font-size="9" fill="#B45309">(r, d_out)</text>

  <!-- Scaling -->
  <line x1="545" y1="270" x2="558" y2="270" stroke="#F59E0B" stroke-width="1.5"/>
  <rect x="560" y="257" width="45" height="26" rx="13" fill="#FEF3C7" stroke="#D97706" stroke-width="1"/>
  <text x="582" y="274" text-anchor="middle" font-size="10" font-weight="600" fill="#92400E">× α/r</text>

  <!-- W' = W0 + scaled BA -->
  <line x1="605" y1="270" x2="618" y2="270" stroke="#64748B" stroke-width="1.5"/>
  <text x="632" y="274" text-anchor="middle" font-size="11" fill="#64748B">=</text>

  <rect x="645" y="255" width="80" height="32" rx="6" fill="#F0F9FF" stroke="#3B82F6" stroke-width="1"/>
  <text x="685" y="275" text-anchor="middle" font-size="11" font-weight="600" fill="#1E40AF">W'</text>
  <text x="685" y="284" text-anchor="middle" font-size="8" fill="#3B82F6">(adapted)</text>

  <!-- Normalize -->
  <line x1="685" y1="255" x2="685" y2="210" stroke="#06B6D4" stroke-width="2"/>
  <rect x="640" y="175" width="90" height="40" rx="8" fill="#ECFEFF" stroke="#06B6D4" stroke-width="2" filter="url(#shadow)"/>
  <text x="685" y="193" text-anchor="middle" font-size="11" font-weight="700" fill="#0E7490">Normalize</text>
  <text x="685" y="208" text-anchor="middle" font-size="9" fill="#06B6D4">W' / ‖W'‖_col</text>

  <!-- Direction output -->
  <line x1="730" y1="195" x2="755" y2="195" stroke="#06B6D4" stroke-width="2"/>
  <rect x="758" y="180" width="80" height="32" rx="6" fill="#ECFEFF" stroke="#06B6D4" stroke-width="1"/>
  <text x="798" y="200" text-anchor="middle" font-size="11" font-weight="600" fill="#0E7490">V̂ (dir)</text>

  <!-- === Magnitude Path === -->
  <line x1="170" y1="217" x2="170" y2="155" stroke="#EC4899" stroke-width="2"/>
  <line x1="170" y1="155" x2="280" y2="155" stroke="#EC4899" stroke-width="2" marker-end="url(#arrPink)"/>

  <text x="220" y="140" font-size="11" font-weight="600" fill="#EC4899">MAGNITUDE PATH</text>

  <!-- Magnitude vector -->
  <rect x="285" y="138" width="140" height="40" rx="8" fill="#FDF2F8" stroke="#EC4899" stroke-width="2" filter="url(#shadow)"/>
  <text x="355" y="158" text-anchor="middle" font-size="12" font-weight="700" fill="#BE185D">m (magnitude)</text>
  <text x="355" y="172" text-anchor="middle" font-size="9" fill="#EC4899">trainable, (d_out,)</text>

  <text x="440" y="155" font-size="10" fill="#94A3B8" font-style="italic">init: m = ‖W₀‖_col</text>

  <!-- m goes to multiply -->
  <line x1="425" y1="158" x2="550" y2="158" stroke="#EC4899" stroke-width="2"/>

  <!-- Multiply node (m × direction) -->
  <circle cx="830" cy="148" r="18" fill="#FDF2F8" stroke="#EC4899" stroke-width="2"/>
  <text x="830" y="154" text-anchor="middle" font-size="16" font-weight="700" fill="#EC4899">×</text>

  <!-- m to multiply -->
  <line x1="550" y1="158" x2="550" y2="148" stroke="#EC4899" stroke-width="1.5"/>
  <line x1="550" y1="148" x2="812" y2="148" stroke="#EC4899" stroke-width="1.5"/>

  <!-- direction to multiply -->
  <line x1="838" y1="196" x2="850" y2="196" stroke="#06B6D4" stroke-width="1.5"/>
  <line x1="850" y1="196" x2="850" y2="165" stroke="#06B6D4" stroke-width="1.5"/>
  <line x1="850" y1="165" x2="845" y2="155" stroke="#06B6D4" stroke-width="1.5"/>

  <!-- Final weight and output -->
  <line x1="848" y1="148" x2="865" y2="148" stroke="#64748B" stroke-width="2"/>
  <rect x="868" y="128" width="45" height="40" rx="8" fill="#F0FDF4" stroke="#10B981" stroke-width="2"/>
  <text x="890" y="148" text-anchor="middle" font-size="14" font-weight="700" fill="#065F46">h</text>
  <text x="890" y="162" text-anchor="middle" font-size="8" fill="#10B981">output</text>

  <!-- Explanation boxes -->
  <rect x="30" y="360" width="420" height="155" rx="10" fill="white" stroke="#E2E8F0" stroke-width="1" filter="url(#shadow)"/>
  <text x="50" y="385" font-size="14" font-weight="700" fill="#1E293B">Why Decompose?</text>
  <line x1="50" y1="395" x2="430" y2="395" stroke="#E2E8F0" stroke-width="0.5"/>

  <text x="50" y="415" font-size="11" fill="#475569">Full fine-tuning independently changes:</text>
  <rect x="60" y="425" width="170" height="22" rx="4" fill="#FDF2F8" stroke="#FBCFE8" stroke-width="0.5"/>
  <text x="145" y="440" text-anchor="middle" font-size="10" fill="#BE185D" font-weight="600">Magnitude (how strongly)</text>
  <rect x="240" y="425" width="190" height="22" rx="4" fill="#FEF3C7" stroke="#FDE68A" stroke-width="0.5"/>
  <text x="335" y="440" text-anchor="middle" font-size="10" fill="#92400E" font-weight="600">Direction (which features)</text>

  <text x="50" y="468" font-size="11" fill="#475569">Standard LoRA entangles both — ΔW = BA shifts</text>
  <text x="50" y="484" font-size="11" fill="#475569">magnitude and direction simultaneously.</text>
  <text x="50" y="504" font-size="11" fill="#065F46" font-weight="600">DoRA decouples them → closer to full FT behavior</text>

  <!-- Parameter cost -->
  <rect x="470" y="360" width="420" height="155" rx="10" fill="white" stroke="#E2E8F0" stroke-width="1" filter="url(#shadow)"/>
  <text x="490" y="385" font-size="14" font-weight="700" fill="#1E293B">Parameter Cost (4096 × 4096 projection)</text>
  <line x1="490" y1="395" x2="870" y2="395" stroke="#E2E8F0" stroke-width="0.5"/>

  <!-- LoRA params -->
  <rect x="490" y="408" width="12" height="12" rx="2" fill="#FEF3C7" stroke="#F59E0B" stroke-width="1"/>
  <text x="510" y="418" font-size="12" fill="#475569">LoRA A + B (r=16):</text>
  <text x="680" y="418" font-size="12" fill="#1E293B" font-weight="600">131,072 params</text>

  <!-- Magnitude params -->
  <rect x="490" y="432" width="12" height="12" rx="2" fill="#FDF2F8" stroke="#EC4899" stroke-width="1"/>
  <text x="510" y="442" font-size="12" fill="#475569">Magnitude vector m:</text>
  <text x="680" y="442" font-size="12" fill="#1E293B" font-weight="600">4,096 params</text>

  <!-- Total -->
  <line x1="490" y1="454" x2="870" y2="454" stroke="#E2E8F0" stroke-width="0.5"/>
  <text x="510" y="472" font-size="12" fill="#475569">Total DoRA overhead:</text>
  <text x="680" y="472" font-size="12" fill="#1E293B" font-weight="600">135,168 params</text>
  <text x="510" y="492" font-size="11" fill="#94A3B8">Magnitude adds only ~3% over standard LoRA</text>

  <!-- PEFT usage -->
  <rect x="490" y="500" width="380" height="20" rx="4" fill="#F5F3FF" stroke="#DDD6FE" stroke-width="0.5"/>
  <text x="680" y="514" text-anchor="middle" font-size="10" fill="#7C3AED" font-family="'Cascadia Code', monospace">LoraConfig(use_dora=True) — just one flag in PEFT!</text>
</svg>
